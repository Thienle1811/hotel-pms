<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Tạo Booking cho Phòng {{ room.room_number }}</title>
    <style>
      body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
      .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
      h2 { border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; color: #333; }
      .form-section { margin-bottom: 30px; border: 1px solid #e0e0e0; padding: 20px; border-radius: 6px; background: #fff; }
      .form-field { margin-bottom: 15px; }
      label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
      input[type="text"], input[type="date"], input[type="datetime-local"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
      button { padding: 10px 20px; cursor: pointer; border-radius: 5px; font-weight: bold; border: none; }
      .btn-primary { background-color: #007bff; color: white; width: 100%; font-size: 1.1em; }
      .btn-success { background-color: #28a745; color: white; }
      .btn-danger { background-color: #dc3545; color: white; padding: 5px 10px; font-size: 0.8em; float: right; }
      .back-link { display: block; text-align: center; margin-top: 20px; color: #666; text-decoration: none; }
      .guest-item { border-top: 2px dashed #ccc; padding-top: 20px; margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 4px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Check-in Phòng {{ room.room_number }} ({{ room.room_type }})</h2>
      
      {% if messages %}
        {% for message in messages %}
          <div style="padding: 10px; background: #f8d7da; color: #721c24; margin-bottom: 15px; border: 1px solid #f5c6cb;">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form method="POST" enctype="multipart/form-data" id="bookingForm">
        {% csrf_token %}

        <div class="form-section" style="background: #e3f2fd; border-color: #90caf9;">
            <h3 style="margin-top: 0; color: #0d47a1;">1. Thông tin Đặt phòng</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                {% for field in reservation_form %}
                <div class="form-field" {% if field.name == 'note' %}style="grid-column: span 2;"{% endif %}>
                    <label>{{ field.label }}:</label>
                    {{ field }}
                    {{ field.errors }}
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="form-section">
            <h3 style="margin-top: 0;">2. Trưởng đoàn / Người đại diện</h3>
            {% for field in main_guest_form %}
                <div class="form-field">
                    <label>{{ field.label }}:</label>
                    {{ field }}
                    {{ field.errors }}
                </div>
            {% endfor %}
        </div>

        <div class="form-section">
            <h3 style="margin-top: 0;">3. Khách đi cùng</h3>
            {{ guest_formset.management_form }} <div id="guest-list">
                {% for form in guest_formset %}
                    <div class="guest-item">
                        <h4 style="margin-top: 0;">Thông tin Khách phụ</h4>
                        {{ form.as_p }}
                    </div>
                {% endfor %}
            </div>

            <div style="margin-top: 15px;">
                <button type="button" id="add-guest-btn" class="btn-success">+ Thêm khách khác</button>
            </div>
        </div>

        <div id="empty-form" style="display:none;">
            <div class="guest-item">
                <button type="button" class="btn-danger remove-guest">Xóa</button>
                <h4 style="margin-top: 0; color: #555;">Thông tin Khách phụ <span class="counter"></span></h4>
                <table>{{ guest_formset.empty_form.as_table }}</table>
            </div>
        </div>

        <button type="submit" class="btn-primary">Lưu Booking & Check-in</button>
        <a href="{% url 'dashboard' %}" class="back-link">Quay lại Dashboard</a>
      </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addBtn = document.getElementById('add-guest-btn');
            const guestList = document.getElementById('guest-list');
            const emptyFormHtml = document.getElementById('empty-form').innerHTML;
            const totalFormsInput = document.getElementById('id_others-TOTAL_FORMS'); 

            addBtn.addEventListener('click', function() {
                const currentCount = parseInt(totalFormsInput.value);
                // Thay thế __prefix__ bằng index hiện tại
                const newFormHtml = emptyFormHtml.replace(/__prefix__/g, currentCount);
                
                const div = document.createElement('div');
                div.innerHTML = newFormHtml;
                div.querySelector('.counter').innerText = `#${currentCount + 1}`;
                
                guestList.appendChild(div.firstElementChild);
                totalFormsInput.value = currentCount + 1;
            });

            // Xử lý nút xóa
            guestList.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-guest')) {
                    e.target.closest('.guest-item').remove();
                    // Lưu ý: Đơn giản thì ta không cần giảm Total Forms, Django sẽ tự bỏ qua form lỗi/thiếu
                }
            });
        });
    </script>
  </body>
</html>