{% extends 'pms/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
  .room-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
  .room-card { padding: 20px; border-radius: 8px; text-align: center; color: white; position: relative; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
  .room-card:hover { transform: translateY(-3px); }
  .status-Vacant { background-color: #28a17a; }
  .status-Booked { background-color: #ffc107; color: #343a40; }
  .status-Occupied { background-color: #dc3545; }
  .status-Dirty { background-color: #6c757d; }
  .alerting { animation: blink 1s step-end infinite; }
  @keyframes blink { 0%, 100% { background-color: #ffc107; } 50% { background-color: #dc3545; color: white;} }
  .card-actions { margin-top: 15px; }
  .card-actions a { display: block; padding: 8px; margin-top: 8px; background-color: rgba(255, 255, 255, 0.2); color: inherit; text-decoration: none; border-radius: 4px; font-weight: bold; }
  .card-actions a:hover { background-color: rgba(255, 255, 255, 0.4); }
  .quick-action-button { background-color: #007bff !important; color: white !important; }
{% endblock %}

{% block content %}
  <h2>{{ page_title }}</h2>
  
  {% if not room_data %}
  <div style="padding: 20px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px;">
      <h3>⚠️ Chưa có dữ liệu phòng</h3>
      <p>Vui lòng tạo Khách sạn và 7 Phòng trong trang Admin, sau đó Refresh trang này.</p>
      <a href="{% url 'manage-rooms' %}" style="color: #007bff; font-weight: bold;">Tạo phòng ngay</a>
  </div>
  {% endif %}

  <div class="room-grid">
    {% for data in room_data %}
    <div class="room-card status-{{ data.room.status }} {% if data.is_alerting %}alerting{% endif %}">
        <h3>Phòng {{ data.room.room_number }}</h3>
        <p style="font-weight: bold;">{{ data.room.get_status_display }}</p>

        {% if data.reservation %}
            <p>Khách: {{ data.guest_name }}</p>
            {% if data.room.status == 'Booked' %}
                <p>Check-in: {{ data.reservation.check_in_date|date:"H:i d/m" }}</p>
                {% if data.is_alerting %}
                    <p style="font-weight: bold;">(SẮP CHECK-IN)</p>
                {% endif %}
            {% elif data.room.status == 'Occupied' %}
                <p>Check-out D.kiến: 
                    {% if data.reservation.check_out_date %}
                        {{ data.reservation.check_out_date|date:"H:i d/m" }}
                    {% else %}
                        (Chưa xác định)
                    {% endif %}
                </p>
            {% endif %}
        {% endif %}

        <div class="card-actions">
            {% if data.room.status == 'Vacant' or data.room.status == 'Dirty' %}
                <a href="{% url 'create-booking' data.room.id %}" class="quick-action-button">Tạo Booking/Check-in</a>
            {% elif data.room.status == 'Booked' %}
                <a href="{% url 'perform-check-in' data.reservation.id %}" class="quick-action-button">Check-in</a>
                <a href="#">Hủy Booking</a>
            {% elif data.room.status == 'Occupied' %}
                <a href="{% url 'manage-room-services' data.reservation.id %}">Thêm Dịch vụ</a> 
                <a href="{% url 'billing-details' data.reservation.id %}" class="quick-action-button">Check-out (Hóa đơn)</a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
  </div>

<div id="registryOverlay" class="overlay"></div>
<div id="registryReminderPopup" class="notification-popup">
    <div class="popup-title" style="color: #dc3545;">⚠️ NHẮC NHỞ QUAN TRỌNG!</div>
    <div class="popup-message" id="registryPopupMessage">
        </div>
    
    <button onclick="closeRegistryReminder()" class="popup-btn close-btn" style="background-color: #007bff; margin-left: 0;">Đã Đọc</button>
</div>

<script>
    // Hàm hiển thị thông báo
    function showRegistryReminder(time) {
        // Hiển thị lớp phủ và popup
        document.getElementById('registryOverlay').style.display = 'block';
        document.getElementById('registryReminderPopup').style.display = 'block';
        
        // Cập nhật tin nhắn 
        document.getElementById('registryPopupMessage').innerHTML = 
            `Đã đến giờ **${time}**. Vui lòng dành thời gian in file tạm trú cho khách lưu trú hôm nay và bàn giao cho ca tiếp theo.`;
    }

    // Hàm đóng thông báo
    function closeRegistryReminder() {
        document.getElementById('registryOverlay').style.display = 'none';
        document.getElementById('registryReminderPopup').style.display = 'none';
    }

    // Kiểm tra và hiển thị thông báo
    function checkAndShowRegistryReminder() {
        var now = new Date();
        var hours = now.getHours();
        var minutes = now.getMinutes();
        
        // Tạo chuỗi thời gian HH:MM cho dễ so sánh
        var currentTime = (hours < 10 ? '0' + hours : hours) + ':' + (minutes < 10 ? '0' + minutes : minutes);

        // ĐỊNH NGHĨA CÁC MỐC THỜI GIAN NHẮC NHỞ THEO YÊU CẦU: 7:00 sáng (07:00) và 10:30 tối (22:30)
        var reminderTimes = {
            "07:00": "7:00 sáng",
            "22:30": "10:30 tối"
        };
        
        var targetTime = reminderTimes[currentTime];

        if (targetTime) {
            // Logic chống spam: Chỉ hiển thị một lần trong 5 phút
            var reminderShownKey = 'registry_reminder_' + currentTime;
            var lastShown = sessionStorage.getItem(reminderShownKey);
            var fiveMinutes = 5 * 60 * 1000; 

            if (!lastShown || (now.getTime() - lastShown) > fiveMinutes) {
                showRegistryReminder(targetTime);
                sessionStorage.setItem(reminderShownKey, now.getTime());
            }
        }
    }

    // Chạy kiểm tra mỗi 15 giây (để đảm bảo không bỏ lỡ mốc thời gian)
    setInterval(checkAndShowRegistryReminder, 15000); 

    // Chạy kiểm tra ngay khi tải trang
    document.addEventListener('DOMContentLoaded', checkAndShowRegistryReminder);
</script>

{% endblock %}