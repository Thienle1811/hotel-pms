{% extends 'pms/base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
  .service-form-container { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 30px; background-color: white; }
  .form-field { margin-bottom: 15px; }
  .form-field label { display: block; font-weight: bold; margin-bottom: 5px; }
  .form-field input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
  .total-row { background-color: #fff3cd; font-weight: bold; }
{% endblock %}

{% block content %}
  <h2>{{ page_title }}</h2>
  <p style="font-size: 1.1em; font-weight: bold;">Khách hàng: {{ reservation.guest.full_name }}</p>

  <div class="service-form-container">
    <h3>Thêm Dịch vụ/Sản phẩm</h3>

    <div style="margin-bottom: 15px; padding: 10px; background-color: #e9ecef; border-radius: 4px;">
        <label style="font-weight: bold;">⭐ Chọn nhanh từ Thực đơn:</label>
        <select id="quick-select" onchange="selectService()" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;">
            <option value="">-- Chọn món để tự điền --</option>
            {% for item in inventory_items %}
                <option value="{{ item.item_name }}" data-price="{{ item.price|floatformat:0 }}">
                    {{ item.item_name }} - {{ item.price|floatformat:0 }} VND
                </option>
            {% endfor %}
        </select>
    </div>

    <form action="{% url 'add-service-charge' reservation.id %}" method="POST" style="display: flex; gap: 10px; align-items: flex-end;">
        {% csrf_token %}
        
        <div class="form-field" style="flex: 3;">
            <label for="id_item_name">Tên Dịch vụ:</label>
            {{ service_form.item_name }}
        </div>
        <div class="form-field" style="flex: 1;">
            <label for="id_quantity">Số lượng:</label>
            {{ service_form.quantity }}
        </div>
        <div class="form-field" style="flex: 2;">
            <label for="id_price">Đơn giá:</label>
            {{ service_form.price }}
        </div>
        
        <button type="submit" class="btn-action btn-blue" style="flex: 1; height: 38px; border:none; cursor:pointer;">Thêm</button>
    </form>
  </div>

  <script>
    function selectService() {
        var selectBox = document.getElementById("quick-select");
        var selectedOption = selectBox.options[selectBox.selectedIndex];

        if (selectedOption.value !== "") {
            document.getElementById("id_item_name").value = selectedOption.value;
            var price = selectedOption.getAttribute("data-price");
            document.getElementById("id_price").value = price.replace(/,/g, '').replace(/\./g, '');
        }
    }
  </script>
  
  <h3>Danh sách Phí Dịch vụ Đã Ghi nhận</h3>
  <table>
    <thead>
      <tr>
        <th>STT</th>
        <th>Tên Dịch vụ</th>
        <th>Số lượng</th>
        <th>Đơn giá (VND)</th>
        <th>Tổng cộng (VND)</th>
        <th>Thời điểm</th>
      </tr>
    </thead>
    <tbody>
      {% for charge in service_charges %}
      <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ charge.item_name }}</td>
        <td>{{ charge.quantity }}</td>
        <td>{{ charge.price|floatformat:0|default:"0" }}</td>
        <td>{{ charge.total_price|floatformat:0|default:"0" }}</td>
        <td>{{ charge.created_at|date:"H:i d/m" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6">Chưa có dịch vụ nào được ghi nhận.</td>
      </tr>
      {% endfor %}
      <tr class="total-row">
        <td colspan="4" style="text-align: right;">TỔNG CỘNG PHÍ DỊCH VỤ:</td>
        <td>{{ total_service_cost|floatformat:0|default:"0" }}</td>
        <td></td>
      </tr>
    </tbody>
  </table>
  
  <div style="margin-top: 20px;">
      <a href="{% url 'dashboard' %}" style="color: #007bff; text-decoration: none;">&larr; Quay lại Dashboard</a>
  </div>
{% endblock %}