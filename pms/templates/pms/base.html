<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Quáº£n lÃ½ KhÃ¡ch sáº¡n{% endblock %}</title>
    <style>
      body { font-family: sans-serif; margin: 0; display: flex; min-height: 100vh; }
      
      /* --- SIDEBAR CHUNG --- */
      .sidebar { width: 250px; background-color: #343a40; color: white; padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
      .sidebar h3 { margin-top: 0; border-bottom: 1px solid #495057; padding-bottom: 10px; }
      .sidebar a { color: white; text-decoration: none; display: block; padding: 10px 15px; margin-bottom: 5px; border-radius: 4px; transition: 0.2s; }
      .sidebar a:hover { background-color: #495057; padding-left: 20px; }
      .sidebar .active { background-color: #007bff; font-weight: bold; }
      .menu-label { font-size: 12px; color: #adb5bd; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
      .logout-link { background-color: #dc3545; text-align: center; margin-top: 20px; }
      .logout-link:hover { background-color: #c82333; }

      /* --- Ná»˜I DUNG CHÃNH --- */
      .content { flex-grow: 1; padding: 30px; background-color: #f8f9fa; }
      
      /* --- CSS CHUNG CHO Báº¢NG VÃ€ NÃšT --- */
      table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
      th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
      th { background-color: #e9ecef; }
      .btn-action { padding: 5px 10px; border-radius: 4px; text-decoration: none; color: white; font-size: 0.9em; margin-right: 5px; }
      .btn-blue { background-color: #007bff; }
      .btn-green { background-color: #28a745; }
      .btn-red { background-color: #dc3545; }
      
      /* CSS riÃªng cá»§a tá»«ng trang sáº½ Ä‘Æ°á»£c chÃ¨n vÃ o Ä‘Ã¢y */
      {% block extra_css %}{% endblock %}
    </style>
  </head>
  <body>
    
    <div class="sidebar">
        <h3 style="text-align: center;">SmartCity HomeTel</h3>
        
        <div class="menu-label">Lá»… tÃ¢n</div>
        <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
            ğŸ“Š SÆ¡ Ä‘á»“ PhÃ²ng
        </a>
        <a href="{% url 'reservation-calendar' %}" class="{% if request.resolver_match.url_name == 'reservation-calendar' %}active{% endif %}">
            ğŸ“… Lá»‹ch Äáº·t phÃ²ng
        </a>
        <a href="{% url 'manage-requests' %}" class="{% if request.resolver_match.url_name == 'manage-requests' %}active{% endif %}">
            ğŸ”” YÃªu cáº§u (QR)
        </a>
        <a href="{% url 'manage-guests' %}" class="{% if request.resolver_match.url_name == 'manage-guests' %}active{% endif %}">
            ğŸ‘¥ KhÃ¡ch hÃ ng
        </a>

        {% if user.is_superuser %}
            <hr style="border-color: #495057; margin: 15px 0;">

            <div class="menu-label" style="color: #ffc107;">Quáº£n trá»‹ viÃªn</div>
            
            <a href="{% url 'management-dashboard' %}" class="{% if request.resolver_match.url_name == 'management-dashboard' %}active{% endif %}">
                ğŸ“ˆ BÃ¡o cÃ¡o & Lá»‹ch
            </a>
            
            <a href="{% url 'manage-staff' %}" class="{% if request.resolver_match.url_name == 'manage-staff' %}active{% endif %}">
                ğŸ‘” Quáº£n lÃ½ NhÃ¢n sá»±
            </a>
            
            <a href="{% url 'export-registry' %}" class="{% if request.resolver_match.url_name == 'export-registry' %}active{% endif %}">
                ğŸ‘® Xuáº¥t File Táº¡m TrÃº
            </a>

            <div class="menu-label">Cáº¥u hÃ¬nh</div>
            
            <a href="{% url 'manage-rooms' %}" class="{% if request.resolver_match.url_name == 'manage-rooms' %}active{% endif %}">
                ğŸ›ï¸ Cáº¥u hÃ¬nh PhÃ²ng
            </a>
            
            <a href="{% url 'manage-service-inventory' %}" class="{% if request.resolver_match.url_name == 'manage-service-inventory' %}active{% endif %}">
                ğŸ” Menu Dá»‹ch vá»¥
            </a>
        {% endif %}

        <div style="margin-top: auto;">
            <div style="text-align: center; font-size: 0.9em; color: #ccc; margin-bottom: 5px;">
                {% if user.is_superuser %} (Admin) {% else %} (NhÃ¢n viÃªn) {% endif %}
            </div>
            <a href="{% url 'logout' %}" class="logout-link">ÄÄƒng xuáº¥t ({{ user.username }})</a>
        </div>
    </div>

    <div class="content">
        {% if messages %}
            {% for message in messages %}
                <div style="padding: 10px; margin-bottom: 15px; border-radius: 4px; background-color: {% if message.tags == 'error' %}#f8d7da{% else %}#d4edda{% endif %}; color: {% if message.tags == 'error' %}#721c24{% else %}#155724{% endif %};">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <script>
        let lastCount = -1; // Khá»Ÿi táº¡o -1 Ä‘á»ƒ láº§n Ä‘áº§u cháº¡y khÃ´ng bÃ¡o

        function checkNewRequests() {
            // Gá»i API Ä‘á»ƒ láº¥y sá»‘ lÆ°á»£ng yÃªu cáº§u má»›i
            fetch("{% url 'ajax-new-requests-count' %}")
                .then(response => response.json())
                .then(data => {
                    const currentCount = data.count;
                    
                    // Láº§n Ä‘áº§u táº£i trang: chá»‰ cáº­p nháº­t sá»‘ lÆ°á»£ng, khÃ´ng bÃ¡o
                    if (lastCount === -1) {
                        lastCount = currentCount;
                        return;
                    }

                    // Náº¿u sá»‘ lÆ°á»£ng tÄƒng lÃªn -> CÃ“ YÃŠU Cáº¦U Má»šI!
                    if (currentCount > lastCount) {
                        playNotification();
                        showBrowserNotification(currentCount);
                    }
                    
                    // Cáº­p nháº­t láº¡i sá»‘ lÆ°á»£ng Ä‘á»ƒ láº§n sau so sÃ¡nh
                    lastCount = currentCount;
                })
                .catch(error => console.error('Lá»—i kiá»ƒm tra yÃªu cáº§u:', error));
        }

        function playNotification() {
            const audio = document.getElementById('notificationSound');
            // CÃ¡c trÃ¬nh duyá»‡t hiá»‡n Ä‘áº¡i cháº·n tá»± phÃ¡t Ã¢m thanh náº¿u chÆ°a tÆ°Æ¡ng tÃ¡c
            audio.play().catch(error => console.log('ChÆ°a thá»ƒ phÃ¡t Ã¢m thanh do chÃ­nh sÃ¡ch trÃ¬nh duyá»‡t:', error));
        }

        function showBrowserNotification(count) {
            if (!("Notification" in window)) return;

            if (Notification.permission === "granted") {
                new Notification("ğŸ›ï¸ CÃ“ YÃŠU Cáº¦U Má»šI!", {
                    body: `KhÃ¡ch hÃ ng Ä‘ang gá»i! CÃ³ ${count} yÃªu cáº§u chÆ°a xá»­ lÃ½.`,
                    icon: "https://cdn-icons-png.flaticon.com/512/3602/3602145.png" // Icon cÃ¡i chuÃ´ng
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        showBrowserNotification(count);
                    }
                });
            }
        }

        // Xin quyá»n thÃ´ng bÃ¡o ngay khi má»Ÿ trang
        if ("Notification" in window && Notification.permission !== "denied") {
            Notification.requestPermission();
        }

        // Cháº¡y kiá»ƒm tra má»—i 10 giÃ¢y (10000ms)
        setInterval(checkNewRequests, 10000);
    </script>

  </body>
</html>