<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>{% block title %}Qu·∫£n l√Ω Kh√°ch s·∫°n{% endblock %}</title>
    <style>
      body { font-family: sans-serif; margin: 0; display: flex; min-height: 100vh; }
      
      /* --- SIDEBAR CHUNG --- */
      .sidebar { width: 250px; background-color: #343a40; color: white; padding: 20px; flex-shrink: 0; display: flex; flex-direction: column; }
      .sidebar h3 { margin-top: 0; border-bottom: 1px solid #495057; padding-bottom: 10px; }
      .sidebar a { color: white; text-decoration: none; display: block; padding: 10px 15px; margin-bottom: 5px; border-radius: 4px; transition: 0.2s; }
      .sidebar a:hover { background-color: #495057; padding-left: 20px; }
      .sidebar .active { background-color: #007bff; font-weight: bold; }
      .menu-label { font-size: 12px; color: #adb5bd; margin-top: 15px; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; }
      .logout-link { background-color: #dc3545; text-align: center; margin-top: 20px; }
      .logout-link:hover { background-color: #c82333; }

      /* --- N·ªòI DUNG CH√çNH --- */
      .content { flex-grow: 1; padding: 30px; background-color: #f8f9fa; position: relative; }
      
      /* --- CSS CHUNG CHO B·∫¢NG V√Ä N√öT --- */
      table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
      th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
      th { background-color: #e9ecef; }
      .btn-action { padding: 5px 10px; border-radius: 4px; text-decoration: none; color: white; font-size: 0.9em; margin-right: 5px; }
      .btn-blue { background-color: #007bff; }
      .btn-green { background-color: #28a745; }
      .btn-red { background-color: #dc3545; }

      /* --- POPUP TH√îNG B√ÅO (M·ªöI) --- */
      .overlay {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
          position: fixed;
          top: 0; left: 0; width: 100%; height: 100%;
          background-color: rgba(0, 0, 0, 0.5); /* N·ªÅn t·ªëi m·ªù */
          z-index: 9998;
      }
      .notification-popup {
          display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
          position: fixed;
          top: 50%; left: 50%;
          transform: translate(-50%, -50%);
          background-color: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 5px 15px rgba(0,0,0,0.3);
          z-index: 9999;
          text-align: center;
          width: 400px;
          border: 2px solid #dc3545;
          animation: popin 0.3s ease-out;
      }
      @keyframes popin { from { transform: translate(-50%, -60%); opacity: 0; } to { transform: translate(-50%, -50%); opacity: 1; } }
      
      .popup-title { color: #dc3545; font-size: 24px; margin-bottom: 10px; font-weight: bold; }
      .popup-message { font-size: 18px; margin-bottom: 25px; color: #333; }
      .popup-btn {
          background-color: #007bff; color: white; padding: 10px 20px;
          border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold;
          text-decoration: none; display: inline-block;
      }
      .popup-btn:hover { background-color: #0056b3; }
      .close-btn {
          background-color: #6c757d; margin-left: 10px;
      }
      
      /* CSS ri√™ng c·ªßa t·ª´ng trang s·∫Ω ƒë∆∞·ª£c ch√®n v√†o ƒë√¢y */
      {% block extra_css %}{% endblock %}
    </style>
  </head>
  <body>
    
    <div class="sidebar">
        <h3 style="text-align: center;">SmartCity HomeTel</h3>
        
        <div class="menu-label">L·ªÖ t√¢n</div>
        <a href="{% url 'dashboard' %}" class="{% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">üìä S∆° ƒë·ªì Ph√≤ng</a>
        <a href="{% url 'reservation-calendar' %}" class="{% if request.resolver_match.url_name == 'reservation-calendar' %}active{% endif %}">üìÖ L·ªãch ƒê·∫∑t ph√≤ng</a>
        <a href="{% url 'manage-requests' %}" class="{% if request.resolver_match.url_name == 'manage-requests' %}active{% endif %}">üîî Y√™u c·∫ßu (QR)</a>
        <a href="{% url 'manage-guests' %}" class="{% if request.resolver_match.url_name == 'manage-guests' %}active{% endif %}">üë• Kh√°ch h√†ng</a>

        {% if user.is_superuser %}
            <hr style="border-color: #495057; margin: 15px 0;">

            <div class="menu-label" style="color: #ffc107;">Qu·∫£n tr·ªã vi√™n</div>
            <a href="{% url 'management-dashboard' %}" class="{% if request.resolver_match.url_name == 'management-dashboard' %}active{% endif %}">üìà B√°o c√°o & L·ªãch</a>
            <a href="{% url 'manage-staff' %}" class="{% if request.resolver_match.url_name == 'manage-staff' %}active{% endif %}">üëî Qu·∫£n l√Ω Nh√¢n s·ª±</a>
            <a href="{% url 'export-registry' %}" class="{% if request.resolver_match.url_name == 'export-registry' %}active{% endif %}">üëÆ Xu·∫•t File T·∫°m Tr√∫</a>

            <div class="menu-label">C·∫•u h√¨nh</div>
            <a href="{% url 'manage-rooms' %}" class="{% if request.resolver_match.url_name == 'manage-rooms' %}active{% endif %}">üõèÔ∏è C·∫•u h√¨nh Ph√≤ng</a>
            <a href="{% url 'manage-service-inventory' %}" class="{% if request.resolver_match.url_name == 'manage-service-inventory' %}active{% endif %}">üçî Menu D·ªãch v·ª•</a>
        {% endif %}

        <div style="margin-top: auto;">
            <div style="text-align: center; font-size: 0.9em; color: #ccc; margin-bottom: 5px;">
                {% if user.is_superuser %} (Admin) {% else %} (Nh√¢n vi√™n) {% endif %}
            </div>
            <a href="{% url 'logout' %}" class="logout-link">ƒêƒÉng xu·∫•t ({{ user.username }})</a>
        </div>
    </div>

    <div class="content">
        {% if messages %}
            {% for message in messages %}
                <div style="padding: 10px; margin-bottom: 15px; border-radius: 4px; background-color: {% if message.tags == 'error' %}#f8d7da{% else %}#d4edda{% endif %}; color: {% if message.tags == 'error' %}#721c24{% else %}#155724{% endif %};">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </div>

    <div id="overlay" class="overlay"></div>
    <div id="notificationPopup" class="notification-popup">
        <div class="popup-title">üîî TING TING!</div>
        <div class="popup-message" id="popupMessage">C√≥ y√™u c·∫ßu m·ªõi t·ª´ kh√°ch h√†ng!</div>
        
        <a href="{% url 'manage-requests' %}" class="popup-btn">Xem ngay</a>
        <button onclick="closePopup()" class="popup-btn close-btn">ƒê√≥ng</button>
    </div>

    <audio id="notificationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3" preload="auto"></audio>

    <script>
        let lastCount = -1; 

        function checkNewRequests() {
            fetch("{% url 'ajax-new-requests-count' %}")
                .then(response => response.json())
                .then(data => {
                    const currentCount = data.count;
                    
                    if (lastCount === -1) {
                        lastCount = currentCount;
                        return;
                    }

                    // N·∫øu c√≥ y√™u c·∫ßu m·ªõi -> Hi·ªán Popup
                    if (currentCount > lastCount) {
                        playNotification();
                        showPopup(currentCount);
                    }
                    
                    lastCount = currentCount;
                })
                .catch(error => console.error('L·ªói polling:', error));
        }

        function playNotification() {
            const audio = document.getElementById('notificationSound');
            audio.play().catch(e => console.log('Ch∆∞a t∆∞∆°ng t√°c, kh√¥ng th·ªÉ ph√°t ti·∫øng'));
        }

        function showPopup(count) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('notificationPopup').style.display = 'block';
            document.getElementById('popupMessage').innerText = `Kh√°ch h√†ng ƒëang g·ªçi! C√≥ ${count} y√™u c·∫ßu ch∆∞a x·ª≠ l√Ω.`;
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('notificationPopup').style.display = 'none';
        }

        // Ki·ªÉm tra m·ªói 5 gi√¢y
        setInterval(checkNewRequests, 5000);
    </script>

  </body>
</html>